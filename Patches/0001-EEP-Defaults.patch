From cb810ebde27dd20c0c9c81468b02b01abf54c3bb Mon Sep 17 00:00:00 2001
From: StolenRuby <ruby@mobiusgrid.us>
Date: Mon, 24 Aug 2020 06:16:00 +0100
Subject: [PATCH] EEP Defaults

---
 .../InventoryAccess/InventoryAccessModule.cs  |  46 +++++++++++-------
 bin/assets/SettingsAssetSet/DefaultSky.dat    | Bin 0 -> 1675 bytes
 bin/assets/SettingsAssetSet/DefaultWater.dat  | Bin 0 -> 403 bytes
 .../SettingsAssetSet/SettingsAssetSet.xml     |  14 ++++++
 4 files changed, 43 insertions(+), 17 deletions(-)
 create mode 100644 bin/assets/SettingsAssetSet/DefaultSky.dat
 create mode 100644 bin/assets/SettingsAssetSet/DefaultWater.dat

diff --git a/OpenSim/Region/CoreModules/Framework/InventoryAccess/InventoryAccessModule.cs b/OpenSim/Region/CoreModules/Framework/InventoryAccess/InventoryAccessModule.cs
index 94f0851991..f7bef74acf 100644
--- a/OpenSim/Region/CoreModules/Framework/InventoryAccess/InventoryAccessModule.cs
+++ b/OpenSim/Region/CoreModules/Framework/InventoryAccess/InventoryAccessModule.cs
@@ -226,30 +226,42 @@ namespace OpenSim.Region.CoreModules.Framework.InventoryAccess
                     groupmask = (uint)PermissionMask.AllAndExport;
                     everyonemask = (uint)(PermissionMask.AllAndExport & ~PermissionMask.Modify);                   
                 }
-                if(assetType == (byte)AssetType.Settings)
+
+                if (assetType == (byte)AssetType.Clothing || assetType == (byte)AssetType.Bodypart)
+                    flags = subType;
+
+                AssetBase asset = null;
+
+                if (assetType == (byte)AssetType.Settings)
                 {
-                    if(data == null)
+                    UUID default_asset_id = UUID.Zero;
+
+                    if (subType == 0)
+                        default_asset_id = UUID.Parse("3ae23978-ac82-bcf3-a9cb-ba6e52dcb9ad"); // Sky
+                    else if (subType == 1)
+                        default_asset_id = UUID.Parse("59d1a851-47e7-0e5f-1ed7-6b715154f41a"); // Water
+                    else if (subType == 2)
+                        default_asset_id = UUID.Parse("5646d39e-d3d7-6aff-ed71-30fc87d64a91"); // Daycycle
+
+                    if (default_asset_id != UUID.Zero)
                     {
-                        IEnvironmentModule envModule = m_Scene.RequestModuleInterface<IEnvironmentModule>();
-                        if(envModule == null)
-                            return;
-                        data = envModule.GetDefaultAssetData(subType);
-                        if(data == null)
-                        {
-                            m_log.ErrorFormat(
-                            "[INVENTORY ACCESS MODULE CreateNewInventoryItem]: failed to create default environment setting asset {0} for agent {1}", name, remoteClient.AgentId);
-                            return;
-                        }
+                        asset = m_Scene.AssetService.Get(default_asset_id.ToString());
+                    }
+                    
+                    if (asset == null)
+                    {
+                        m_log.ErrorFormat("[INVENTORY ACCESS MODULE CreateNewInventoryItem]: failed to create default environment setting asset {0} for agent {1}", name, remoteClient.AgentId);
+                        return;
                     }
 
                     flags = subType;
                 }
-                else if( assetType == (byte)AssetType.Clothing ||
-                         assetType == (byte)AssetType.Bodypart)
-                    flags = subType;
+                else
+                {
+                    asset = m_Scene.CreateAsset(name, description, assetType, data, remoteClient.AgentId);
+                    m_Scene.AssetService.Store(asset);
+                }
 
-                AssetBase asset = m_Scene.CreateAsset(name, description, assetType, data, remoteClient.AgentId);
-                m_Scene.AssetService.Store(asset);
                 m_Scene.CreateNewInventoryItem(
                         remoteClient, remoteClient.AgentId.ToString(), string.Empty, folderID,
                         name, description, flags, callbackID, asset.FullID, asset.Type, invType,
diff --git a/bin/assets/SettingsAssetSet/DefaultSky.dat b/bin/assets/SettingsAssetSet/DefaultSky.dat
new file mode 100644
index 0000000000000000000000000000000000000000..8b2a67b87bfa6390a81301a55b35fcc0482622dd
GIT binary patch
literal 1675
zcmb7EO>f*F5be3YqBkyP3m6*{RgL-sD)nAf76zO}#b$-sB%3P#y#xE@B!@OWSTMX9
z-prff%k3xc7xQ@zNhKHNPq$w`{y}P3LfqwjufsgLJ9P8&4}#^A)SUWc<AiP^sgQl#
z^@~>CUbojn?`Esw8I8Hcgfta;a3*a5&l*C=bM-bZeOFvyagIoye^qGkAxyn9=w@H*
zMvh{%SQ_17E=GwvrADlzF?1YsJ=n2A+K0V?Jbj3eW+WR<tJNPu9uXxZHJa9KH)7jC
z+>tPY73mDzAV*3yRbxAx9d=>qjhz>l4m3wDVH?&GDXK^>aaS<*21YiNH5cfm)Emyu
zw=6ma@B63{h>+>C%$`spr4(1stuo;utF&R_?0T=FQ?ovaXToIrFpi5&1t;4I6<bus
z?H91otQZ($*m;}a%9Fjz);l##DuZC@^Ho1%Q<xCQ8$(q)AhT6I9JQg0a!GlO$3{vl
zsS;QSrSZ@(RciuPZ7Srn?Y+IXJ~OJ2w|7b(`mK5b&d{dQ;Oq=+p|%@nt<@jy8vNd#
z>wl^Y=c4I~xV#gr&MVQLq1zDMQ<#rXE*swQ0==wS4$zaJ{j~SV?Yy(lG`Ze{&<;*r
zo)94Y>KKkP=_{Rl^T~F(7i?5MS7=g?{UKMf&EqmTyB<O{yCo!0AS1{I0{>$yq4Yqm
ztMhjptkZ;oP%kI+^(0LJvf0NM3QPgsgdw`SZJO<pn}TdI$!snIVu%=9YYiS`t6=6d
ztQu-CCqx;psOAhf7koUuIl1DP6fuaP1crlc1YwlHgF#CViDHN97r*lqKmxOxpcBwH
zOxcg`s6soh=5=SbbqiTV<>nzgoEnb~TsK1FrX6ZbI8dcy$1o#=*KOT(%<}AV@D{RM
zm;S#B4deR0Dlfke{SZ=uN9!_BN80%$h26@`8Ds+;7GFsK#{Jx@s0&ujM_oX64rKCC
zkp}kVgJ+nKSHI&)p5qK(D+9tn3mp{zjjl3*92vV(1GYYQ#`-Z8HD|QEe4?X`klDZd
QYVc2oU6v0LMb97p0+H1YNB{r;

literal 0
HcmV?d00001

diff --git a/bin/assets/SettingsAssetSet/DefaultWater.dat b/bin/assets/SettingsAssetSet/DefaultWater.dat
new file mode 100644
index 0000000000000000000000000000000000000000..3b3acf30b820b28d4c438b2d3610723c4c6fc971
GIT binary patch
literal 403
zcmZ9I!D_@H5Qcm1Q|!%)N!2xyETwztTP%wh9hZR7U`&>!^xbPr%R<4!`0>v_^UwSF
z;M{E9d`Kz{!5_{auV1KlOO)f{(lEIJB05D<6ONIMFne$^SUW>1xOvi9D+dK;saIpJ
z(I;4yeNYA=j>^eVP3W|=j2SSzt2!lgWd+rh?%S>s#x~q?rj6Y^_Lg7YOJumbD@FxL
z)rWN-NREH32N&*T35HR6OxqH7m2wD-7H=SykF?<?$6$70&hVr<xR4WHw#c**tvKRb
zQr?j~p46-%U7I&}HW={pkRI8JijA*8r5PgV?Vg(vtx1DpMQYAU;|lD*fYL0WH5J$I
Fmmehyfqwu1

literal 0
HcmV?d00001

diff --git a/bin/assets/SettingsAssetSet/SettingsAssetSet.xml b/bin/assets/SettingsAssetSet/SettingsAssetSet.xml
index 1142af8b91..0d0afa055a 100644
--- a/bin/assets/SettingsAssetSet/SettingsAssetSet.xml
+++ b/bin/assets/SettingsAssetSet/SettingsAssetSet.xml
@@ -13,6 +13,20 @@
     <Key Name="fileName" Value="DefaultDaycycle.dat" />
   </Section>
 
+  <Section Name="Default Sky">
+    <Key Name="assetID" Value="3ae23978-ac82-bcf3-a9cb-ba6e52dcb9ad" />
+    <Key Name="name" Value="Default Sky" />
+    <Key Name="assetType" Value="56" />
+    <Key Name="fileName" Value="DefaultSky.dat" />
+  </Section>
+
+  <Section Name="Default Water">
+    <Key Name="assetID" Value="59d1a851-47e7-0e5f-1ed7-6b715154f41a" />
+    <Key Name="name" Value="Default Water" />
+    <Key Name="assetType" Value="56" />
+    <Key Name="fileName" Value="DefaultWater.dat" />
+  </Section>
+
   <Section Name="Sunrise">
     <Key Name="assetID" Value="01e41537-ff51-2f1f-8ef7-17e4df760bfb" />
     <Key Name="name" Value="Sunrise" />
-- 
2.26.2.windows.1

