<html>
<head>
<!--  author - Fred Beckhusen -->
<!--  AGPL3.0  https://opensource.org/licenses/AGPL -->
<!-------- COPYRIGHT 2011 ---------------->
  
<meta name="description" content="Stats for your Opensimulator sim" />
<title>Stats for your sim</title>

<!-- liquidscripts.html begins -->

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1" />
<meta name="author" content="Fred Beckhusen" />
<meta name="copyright" content="Copyright 2011">
<link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png">
<link rel="shortcut icon" type="image/x-ico" href="/favicon.ico" />
<link rel="stylesheet" href="/assets/css/master.css" />
<link rel="stylesheet" media="screen, projection" href="/stats/common/css/liquidscreen.css" type="text/css" />
<link rel="stylesheet" media="print" href="/stats/common/css/liquidprint.css" type="text/css" />

<!-- Jquery -->
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

<!-- tooltips -->
<link rel="stylesheet" type="text/css" media="all" href="/stats/common/css/tipTip.css" />
<script src="/stats/common/js/jquery.tipTip.js" type="text/javascript"></script>
<style>
	
div.form
{
    display: block;
    text-align: center;
	margin-top:50px;
}
form
{
    display: inline-block;
    margin-left: auto;
    margin-right: auto;
    text-align: left;
}

#container {
	width: 900px;
	margin: 0 auto;
}
#stats{
	width: 900px;
	margin: 0 auto;
}
#people li {
	margin-left: 20px;
}
</style>
<script src="https://code.highcharts.com/highcharts.src.js"></script>

<link type="text/css" href="/stats/jqueryui/css/ui-lightness/jquery-ui-1.8.22.custom.css" rel="Stylesheet" />	
<link type="text/css" href="/stats/timepicker/jquery.ui.timepicker.css" rel="Stylesheet" />	
<script type="text/javascript" src="/stats/timepicker/jquery.ui.timepicker.js"></script>
<script src="/flexgrid/js/flexigrid.js"></script>
<link rel="stylesheet" type="text/css" media="all" href="/flexgrid/css/flexigrid.css" />
<script type="text/javascript" >
	
	function gup(name) {
    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    var regexS = "[\\?&]" + name + "=([^&#]*)";
    var regex = new RegExp(regexS);
    var results = regex.exec(window.location.href);
    if (results == null)
        return "";
    else
        return results[1];
}

var edata = {};
var chart;
var chart2;
var chart3;
var title;
var start;
var person;
var GridName;

$(document).ready(function () {

    $("#datepicker1").datepicker();
    $("#datepicker2").datepicker();
    $("#timepicker1").timepicker({
        showPeriodLabels: false,
    });
    $("#timepicker2").timepicker({
        showPeriodLabels: false,
    });

    type = 'Objects';

    var what = gup("q");
    if (what.length > 0) {
        sim = what;
    } else {
        sim = 'Welcome';
    }

    what = gup("Start");
    if (what.length > 0) {
        start = what;
    } else {
        start = '';
    }

    var end;
    what = gup("End");
    if (what.length > 0) {
        end = what;
    } else {
        end = '';
    }


    what = gup("person");
    if (what.length > 0) {
        person = what;
    } else {
        person = '';
    }

    

    $('#submit').click(function () {
        if ($("#datepicker1").val()) {
            start = $("#datepicker1").val();
        }

        if ($("#datepicker2").val()) {
            end = $("#datepicker2").val();
        }

        var simname = $("#mySelect").val();


        var url = '/stats/Map.htm?q=' + simname + '&Start=' + escape(start) + '&End=' + escape(end) + '&Password=' + Password;
        window.location = url;
    });

    $.get('/stats/simvisit.plx?q=' + escape(sim) + '&Start=' + escape(start) + '&End=' + escape(end) + '&person=' + person , null, function (tsv, stat, xhr) {

        $("#status").append(tsv.text);

        $("#datepicker1").val(tsv.s);
        $("#datepicker2").val(tsv.e);

        $("#datepicker1").datepicker();
        $("#datepicker2").datepicker();

        $("#mySelect").val(tsv.sim);

        allVisits = [];
        var html = '<table>';
        html += '<tr><th>Name</th><th>Time Spent</th></tr>';
        title = tsv.title;
        var xsize = tsv.xsize;
        var ysize = tsv.ysize;

		var mapimage = '/Stats/map/map-1-' + tsv.XCoord + '-' + tsv.YCoord + '-objects.jpg' ;

        jQuery.each(tsv.data, function (name, line) {

            var point = {};

            var red = Math.floor(Math.random() * 128 + 128);
            var green = Math.floor(Math.random() * 128 + 128);
            var blue = Math.floor(Math.random() * 128 + 128);
            var color = 'rgba(' + red + ',' + green + ',' + blue + ', 1.0)';

            point.color = color;
            point.data = [];

            var aname = line.name;
            var apoint = line.vectors;
            var visit = line.visits;

            jQuery.each(apoint, function (i, line) {
                var y = line.X;
                var x = line.Y;
                var z = line.Z;

                point.name = aname + ' (' + visit + ' min) &lt;' + x + ',' + y + ',' + z + '&gt;';

                //x = x * 255/xsize;
                //y = y * 255/ysize;

                point.data.push([x, y]);
            });

            allVisits.push(point);

            html += '<tr>'
            html += '<td><a href="/stats/Map.htm?person=' + escape(aname) + '&q=' + escape(sim) +  '&Start=' + escape(tsv.s) + '&End=' + escape(tsv.e) + '">' + aname + '</a></td>';
            html += '<td>' + visit + '</td>';
            html += '</tr>';
        });

        html += '</table>';
		
        $('#people').append(html);

        $("#people").flexigrid({
            width: 900,
            height: 500
        });
	

        var options = {
            chart: {
                renderTo: 'container1',
                marginLeft: 50,
                defaultSeriesType: 'scatter',
                zoomType: 'xy',
                height: 900,
                width: 900,
                events: {
                    load: function () {
                        this.renderer.image(mapimage, 50, 55, 840, 790).add();
                    }
                }
            },
            //series: {
            //	lineWidth: 1,
            //	dashStyle : 'Solid',
            //	connectNulls : true
            //},
            legend: {
                enabled: false
            },
            title: {
                text: ''
            },
            subtitle: {
                text: ''
            },
            xAxis: {
                gridLineColor: '#eeeeee',
                gridLineWidth: 0,
                max: xsize,
                min: 0,
                title: {
                    enabled: true,
                    text: 'X (0-' + xsize + ')'
                },
                startOnTick: false,
                endOnTick: false,
                showLastLabel: true,
                plotLines: [{
                    value: 0,
                    width: 1,
                    color: '#808080'
                }]
            },
            yAxis: {
                gridLineColor: '#eeeeee',
                gridLineWidth: 0,
                max: ysize,
                min: 0,
                title: {
                    enabled: true,
                    text: 'Y (0-' + ysize + ')'
                },
                startOnTick: false,
                endOnTick: false,
                showLastLabel: true
            },
            tooltip: {
                formatter: function () {
                    return '<b>' + this.series.name + '</b>'

                }
            },
            Options: {
                scatter: {
                    marker: {
                        radius: 5,
                        states: {
                            hover: {
                                enabled: true,
                                lineColor: 'rgb(255,255,255)'
                            }
                        }
                    },
                    states: {
                        hover: {
                            marker: {
                                enabled: false
                            }
                        }
                    }
                }
            },
        };

        var options2 = {
            chart: {
                renderTo: 'stats',
                type: 'column',
                height: 250,
                width: 900
            },
            title: {
                text: 'Time in Sim'
            },
            subtitle: {
                text: ''
            },
            xAxis: {
                categories: [

                ]
            },
            yAxis: {
                min: 0,
                title: {
                    text: 'Total time in Minutes'
                }
            },
            legend: {
                layout: 'vertical',
                backgroundColor: '#FFFFFF',
                align: 'left',
                verticalAlign: 'top',
                x: 100,
                y: 70,
                floating: true,
                shadow: true
            },
            tooltip: {
                formatter: function () {
                    return '' +
                        this.x + ': ' + this.y;
                }
            },
            plotOptions: {
                column: {
                    pointPadding: 0.2,
                    borderWidth: 0
                }
            },
            series: []

        };

        var options3 = {
            chart: {
                renderTo: 'daily',
                type: 'column',
                height: 250,
                width: 900
            },
            title: {
                text: 'Visitors by Day'
            },
            subtitle: {
                text: ''
            },
            xAxis: {
                categories: []
            },
            yAxis: {
                min: 0,
                title: {
                    text: 'Visitors by Day'
                }
            },
            legend: {
                layout: 'vertical',
                backgroundColor: '#FFFFFF',
                align: 'left',
                verticalAlign: 'top',
                x: 100,
                y: 70,
                floating: true,
                shadow: true
            },
            tooltip: {
                formatter: function () {
                    return '' +
                        this.x + ': ' + this.y;
                }
            },
            plotOptions: {
                column: {
                    pointPadding: 0.2,
                    borderWidth: 0
                }
            },
            series: []

        };


        // visits by time
        options.title.text = unescape(tsv.sim) + ' ' + title;
        options.subtitle.text = 'Visitors: ' + tsv.visits + ',  Time spent: ' + tsv.time + ' minutes' + ' From: ' + tsv.start + ' To: ' + tsv.end;
        options.series = allVisits;
        console.log(options)

        chart = new Highcharts.Chart(options);

        var points = {
            name: 'Time in Sim',
            data: []
        };


        jQuery.each(tsv.timespent, function (i, line) {
            var Xname = line.date;
            var value = line.count;
            points.data.push(value);

            options2.xAxis.categories.push(Xname);

        });

        options2.series.push(points);
        options2.subtitle.text = 'Visitors: ' + tsv.visits + ',  Time spent: ' + tsv.time + ' minutes' + ' From: ' + tsv.start + ' To: ' + tsv.end;
        chart2 = new Highcharts.Chart(options2);

        // chart 3 - daily visits
        points = {
            name: 'Unique Visitors',
            data: []
        };

        jQuery.each(tsv.daily, function (i, line) {
            var Xname = line.date;
            var value = line.count;
            points.data.push(value);

            options3.xAxis.categories.push(Xname);
        });

        options3.series.push(points);
        options3.subtitle.text = 'Visitors: ' + tsv.visits + ',  Time spent: ' + tsv.time + ' minutes' + ' From: ' + tsv.start + ' To: ' + tsv.end;
        chart3 = new Highcharts.Chart(options3);
    });


});


</script>

</head>

<body>
<div class="form">
	<form action="/stats/Map.htm">
		<table>
			<tr>
			<td>Start Date: <br><input id="datepicker1" name="Start" type="text" value=""></td>
			<td>End Date: <br><input id="datepicker2" type="text" name="End" value=""></td>
			<td> <br><input type="submit" value="Search"></td>	
			</td>
			
		</tr>
		</table>
	</form>
</div>
<input type="hidden"  name="q" id="mySelect" >
	
<div id="container" style="height:900px; width:900px; margin-left: auto;margin-right: auto">
	<p> </p>
	<div id="status" style="width:900px;margin-left: auto;margin-right: auto">
	
	
	<div class="grid12">
	<div class="spacer"></div>
	<br clear="all">
	<div id="container1"  style="height:900px; width:900px; margin-left: auto;margin-right: auto">
		<div class="spacer"></div>
		<br clear="all">
		<img style="display: block;margin-left: auto;margin-right: auto" src="images/spinner.gif" width="100">
	</div>
	<div id="daily"></div>
	<div id="stats"></div>
	<div id="people"></div>
</div>
</body>
</html>